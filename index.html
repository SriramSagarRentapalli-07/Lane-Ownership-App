<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Lane Ownership - VVIT Traffic App</title>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh; overflow-x: hidden;
        }
        .glass-card { 
            background: rgba(255,255,255,0.15); backdrop-filter: blur(25px); 
            border: 1px solid rgba(255,255,255,0.25); border-radius: 24px; 
            box-shadow: 0 25px 45px rgba(0,0,0,0.4); 
        }
        .screen { display: none; min-height: 100vh; padding: 20px; }
        .screen.active { display: block; }
        
        /* Input fixes */
        .input-group { 
            position: relative; margin-bottom: 20px; 
            background: rgba(255,255,255,0.12); border-radius: 20px; padding: 4px;
        }
        .input-group input, .input-group select {
            width: 100%; padding: 20px 24px; background: transparent !important;
            border: none !important; border-radius: 16px; color: #ffffff !important;
            font-size: 16px; font-weight: 500; outline: none;
        }
        .input-group input::placeholder { color: rgba(255,255,255,0.6) !important; }
        .input-group select option { background: #1e293b !important; color: #ffffff !important; }
        
        .login-btn { 
            width: 100%; padding: 20px; background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: #ffffff !important; border: none; border-radius: 20px; 
            font-size: 18px; font-weight: 700; cursor: pointer; margin: 8px 0;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(59,130,246,0.4); }
        
        /* Destination input - FIXED */
        .destination-container {
            position: relative; margin: 20px; background: rgba(255,255,255,0.12);
            border-radius: 20px; padding: 4px; z-index: 10;
        }
        #driverDestination {
            width: 100%; padding: 24px; background: transparent !important;
            border: none !important; border-radius: 16px; color: #ffffff !important;
            font-size: 18px; font-weight: 500; outline: none;
        }
        #driverDestination::placeholder { color: rgba(255,255,255,0.6) !important; }
        
        .autocomplete-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; 
            background: rgba(30,41,59,0.98); border-radius: 0 0 16px 16px;
            max-height: 240px; overflow-y: auto; z-index: 1000; display: none;
            border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .autocomplete-item {
            padding: 20px; cursor: pointer; color: white; border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 16px; transition: background 0.2s;
        }
        .autocomplete-item:hover { background: rgba(255,255,255,0.15); }
        .autocomplete-item:last-child { border-bottom: none; }
        
        /* Map & Navigation */
        #map { height: 60vh; width: calc(100% - 40px); margin: 20px auto; border-radius: 24px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .gps-status { position: absolute; top: 20px; right: 20px; background: rgba(16,185,129,0.95); color: white; padding: 12px 16px; border-radius: 20px; font-weight: 600; z-index: 1000; font-size: 14px; }
        .gps-off { background: rgba(245,101,101,0.95) !important; }
        
        .nav-header { padding: 16px 24px; background: rgba(30,58,138,0.4); color: white; position: sticky; top: 0; z-index: 100; }
        .route-info { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: rgba(16,185,129,0.3); color: white; margin: 16px; border-radius: 20px; }
        .lane-badge { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; padding: 10px 20px; border-radius: 25px; font-weight: 700; }
        
        .gps-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .gps-modal-content { background: linear-gradient(135deg, rgba(30,58,138,0.98), rgba(59,130,246,0.98)); color: white; padding: 40px; border-radius: 24px; text-align: center; max-width: 380px; margin: 20px; }
        .gps-btn { width: 100%; padding: 16px; margin: 10px 0; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; }
        .gps-allow { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
        .gps-deny { background: rgba(255,255,255,0.2); color: white; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Role Selection -->
        <div id="roleScreen" class="screen active" style="padding-top: 100px;">
            <div class="glass-card" style="max-width: 420px; margin: 0 auto; padding: 60px 32px;">
                <h2 style="color: #ffffff; font-size: 32px; margin-bottom: 40px;"><i class="fas fa-road"></i> Dynamic Lane Ownership</h2>
                <button class="login-btn" onclick="showLogin('driver')">
                    <i class="fas fa-car"></i> Driver Navigation
                </button>
                <button class="login-btn" onclick="showLogin('officer')" style="background: linear-gradient(135deg, #ef4444, #dc2626); margin-top: 16px;">
                    <i class="fas fa-user-shield"></i> Traffic Officer
                </button>
            </div>
        </div>

        <!-- DRIVER LOGIN -->
        <div id="driverLoginScreen" class="screen">
            <div style="padding-top: 60px;">
                <div class="glass-card" style="max-width: 420px; margin: 0 auto; padding: 40px;">
                    <h2 style="color: #ffffff;"><i class="fas fa-car"></i> Driver Login</h2>
                    <div class="input-group">
                        <input type="tel" id="driverPhone" placeholder="Phone (9845123456)" value="9845123456">
                    </div>
                    <div class="input-group">
                        <input type="text" id="driverVehicle" placeholder="AP16 AB 1234" value="AP16 AB 1234">
                    </div>
                    <div class="input-group">
                        <select id="driverCompany">
                            <option value="">üîß Select Company</option>
                            <option value="Maruti Suzuki">Maruti Suzuki</option>
                            <option value="Hyundai">Hyundai</option>
                            <option value="Tata">Tata</option>
                            <option value="Mahindra">Mahindra</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <select id="driverModel">
                            <option value="">üöó Select Model</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <select id="driverVehicleType">
                            <option value="carpool">üë• Carpool (3+)</option>
                            <option value="office">üè¢ Office Shuttle</option>
                            <option value="school">üöå School Bus</option>
                            <option value="general">üöó General</option>
                        </select>
                    </div>
                    <button class="login-btn" onclick="driverLogin()">Start Navigation</button>
                    <button class="login-btn" onclick="showRoleScreen()" style="background: rgba(255,255,255,0.1);">‚Üê Back</button>
                </div>
            </div>
        </div>

        <!-- GPS Modal -->
        <div id="gpsModal" class="gps-modal" style="display: none;">
            <div class="gps-modal-content">
                <i class="fas fa-location-arrow" style="font-size: 64px; color: #10b981; margin-bottom: 20px;"></i>
                <h3>Enable Location</h3>
                <p style="margin: 20px 0;">Allow GPS for accurate lane assignment & navigation</p>
                <button class="gps-btn gps-allow" onclick="enableGPS()">‚úÖ Allow Location</button>
                <button class="gps-btn gps-deny" onclick="useFallbackLocation()">üìç Use Default</button>
            </div>
        </div>

        <!-- Driver Screen -->
        <div id="driverScreen" class="screen">
            <div class="nav-header glass-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div id="driverVehicleDisplay" style="font-weight: 700;"></div>
                    <div class="gps-status gps-off" id="gpsStatus">Location OFF</div>
                </div>
            </div>

            <div class="route-info" id="routeSummary" style="display: none;">
                <div>
                    <div id="routeDistance" style="font-size: 24px; font-weight: 700;">-- km</div>
                    <div id="routeETA" style="font-size: 14px;">-- mins</div>
                </div>
                <div class="lane-badge" id="assignedLane">Loading...</div>
            </div>

            <div class="destination-container glass-card">
                <input type="text" id="driverDestination" placeholder="Type destination: Vijayawada, Guntur..." autocomplete="off">
                <div class="autocomplete-dropdown" id="driverAutocomplete"></div>
            </div>
            
            <button class="login-btn" onclick="driverPlanRoute()" style="margin: 0 20px 20px;">üöó Plan Route</button>
            <div id="map" style="height: 55vh;"></div>
        </div>

        <!-- Officer Screen -->
        <div id="officerScreen" class="screen" style="padding-top: 100px;">
            <div class="glass-card" style="max-width: 500px; margin: 0 auto; padding: 60px 40px; text-align: center;">
                <h2 style="color: #ffffff;"><i class="fas fa-user-shield"></i> Officer Dashboard</h2>
                <p style="color: rgba(255,255,255,0.8);">Coming soon...</p>
                <button class="login-btn" onclick="showRoleScreen()" style="background: rgba(255,255,255,0.1);">‚Üê Back</button>
            </div>
        </div>
    </div>

    <script>
        const modelData = {
            "Maruti Suzuki": ["Swift", "Brezza", "Baleno", "Ertiga", "Dzire"],
            "Hyundai": ["Creta", "Venue", "i20", "Verna"],
            "Tata": ["Nexon", "Punch", "Safari"],
            "Mahindra": ["XUV700", "Thar", "Scorpio N"],
            "Toyota": ["Innova Crysta", "Fortuner"],
            "Honda": ["City", "Elevate"],
            "Kia": ["Seltos", "Sonet"]
        };

        let map, userLocation = [16.0844, 80.2262], destination, currentUserData = {};
        const cities = {
            "Vijayawada": [16.5062, 80.6480],
            "Guntur": [16.3067, 80.4365], 
            "Hyderabad": [17.3850, 78.4867],
            "Mangalagiri": [16.4339, 80.5687]
        };

        // Company-model dropdown
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('driverCompany').addEventListener('change', (e) => {
                const company = e.target.value;
                const modelSelect = document.getElementById('driverModel');
                modelSelect.innerHTML = '<option value="">Select Model</option>';
                if (modelData[company]) {
                    modelData[company].forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                }
            });
        });

        function showLogin(role) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(role === 'driver' ? 'driverLoginScreen' : 'officerScreen').classList.add('active');
        }

        function driverLogin() {
            const company = document.getElementById('driverCompany').value;
            const model = document.getElementById('driverModel').value;
            const vtype = document.getElementById('driverVehicleType').value;
            
            if (!company || !model || !vtype) return alert('Select all fields!');
            
            currentUserData = {
                company, model, vtype,
                phone: document.getElementById('driverPhone').value,
                vehicle: document.getElementById('driverVehicle').value
            };
            
            document.getElementById('driverVehicleDisplay').textContent = `${company} ${model}`;
            document.getElementById('driverLoginScreen').classList.remove('active');
            document.getElementById('gpsModal').style.display = 'flex';
        }

        function enableGPS() {
            document.getElementById('gpsModal').style.display = 'none';
            navigator.geolocation.getCurrentPosition(pos => {
                userLocation = [pos.coords.latitude, pos.coords.longitude];
                document.getElementById('gpsStatus').innerHTML = `GPS ON<br>${userLocation[0].toFixed(4)}, ${userLocation[1].toFixed(4)}`;
                document.getElementById('gpsStatus').className = 'gps-status';
                initMap();
            }, useFallbackLocation, {enableHighAccuracy: true});
        }

        function useFallbackLocation() {
            document.getElementById('gpsModal').style.display = 'none';
            document.getElementById('gpsStatus').textContent = 'üìç Guntur Default';
            document.getElementById('gpsStatus').className = 'gps-status gps-off';
            initMap();
        }

        function initMap() {
            map = L.map('map').setView(userLocation, 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker(userLocation).addTo(map).bindPopup('You are here');
        }

        // **DESTINATION INPUT FIXED - 100% WORKING**
        const destInput = document.getElementById('driverDestination');
        const autocomplete = document.getElementById('driverAutocomplete');
        
        destInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            autocomplete.innerHTML = '';
            
            if (query.length < 1) {
                autocomplete.style.display = 'none';
                return;
            }
            
            Object.keys(cities).forEach(city => {
                if (city.toLowerCase().includes(query)) {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${city}`;
                    item.onclick = () => {
                        destInput.value = city;
                        destination = cities[city];
                        autocomplete.style.display = 'none';
                    };
                    autocomplete.appendChild(item);
                }
            });
            
            autocomplete.style.display = autocomplete.children.length ? 'block' : 'none';
        });

        destInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') driverPlanRoute();
        });

        document.addEventListener('click', (e) => {
            if (!destInput.contains(e.target) && !autocomplete.contains(e.target)) {
                autocomplete.style.display = 'none';
            }
        });

        function driverPlanRoute() {
            const cityName = destInput.value;
            if (!destination || !cityName) {
                alert('Type: Vijayawada, Guntur, Hyderabad, Mangalagiri');
                return;
            }
            
            if (map) {
                L.polyline([userLocation, destination], {color: '#10b981', weight: 8}).addTo(map);
                map.fitBounds([userLocation, destination]);
            }
            
            const distance = getDistance(userLocation, destination) / 1000;
            document.getElementById('routeDistance').textContent = `${distance.toFixed(1)} km`;
            document.getElementById('routeETA').textContent = `${Math.round(distance/40*60)} mins`;
            document.getElementById('assignedLane').textContent = currentUserData.vtype === 'carpool' ? 'Lane 3 üü†' : 'Lane 2 üü¢';
            document.getElementById('routeSummary').style.display = 'flex';
            
            alert(`‚úÖ Route to ${cityName}!\n${distance.toFixed(1)}km | ${Math.round(distance/40*60)} mins`);
        }

        function getDistance(p1, p2) {
            const R = 6371;
            const dLat = (p2[0]-p1[0])*Math.PI/180;
            const dLon = (p2[1]-p1[1])*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(p1[0]*Math.PI/180)*Math.cos(p2[0]*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
            return R*c;
        }
    </script>
</body>
</html>

